# DCQCN


## 背景

本文开启了RDMA中的拥塞控制算法的研究。RDMA（Remote Direct Memory Access）技术是一种直接在内存和内存之间进行数据互传的技术，在数据传输的过程中完全实现了Kernel Bypass，CPU不需要参与操作，这也是RDMA在降低CPU消耗的同时，还能带来低时延的原因。最初RDMA的实现为IB网络，它需要一套新的网络基础设施和网卡来支持IB协议，这带来了成本问题。因此，为了将RDMA与现有的以太网基础设施融合，RoCE和iWarp被提出来。关于三种实现之间的对比这里不再赘述，只需要知道市场份额方面，Roce v2领先。Roce中，一个关键的问题就是如何是的现有的网络成为无损网络，目前采用的技术就是IEEE DCB中的PFC（优先级流控制）。PFC通过监控ingress queue以及向上一跳发送PAUSE帧的方式避免交换机缓冲区和NIC缓冲区出现缓存溢出，从而避免丢包。但是部署在大规模网络上需要用到的PFC机制会产生一下两种局限性：

### Unfairness

假如在一个交换机中，流f1使用Ingress 1，流f2、f3共享Ingress 2，Ingress 1和Ingress 2的数据包都被输出到Egress 1。最初始的情况下，如（a）图，三个流平均分配Egress 1。假如下一跳交换机向Egress 1发送了pause报文，则交换机暂停了Ingress1和Ingress2的发送。当下一跳交换机向Egress 1再次发送了resume报文后，Ingress1和Ingress2重新发包，但是此时f2和f3构成竞争关系而f1独占Ingress 1，因此f1拥有比f2和f3更高的吞吐量。其原因是由于pause导致的数据报文堆积，在resume了之后，由于交换机的调度机制会导致（瞬时）的不均衡。


### Victim flow

假如在一个交换机中，流f1、f2共享Ingress 1，然后f1的数据包被转发到Egress 1，f2的数据包被转发到Egress 2。当Egress 1收到pause报文后，它会禁止Ingress 1向外发包，使得本来不受影响的f2页收到影响，此时流f2被称作Victim flow。


PFC存在上述局限性的原因是粒度过于粗（基于端口或者基于队列），因此本文的解决方案就是提出了一个基于端到端流级别的拥塞控制DCQCN。

## DCQCN算法

DCQCN是基于速率和基于反馈的拥塞控制，其设计包括3个部分：

* 拥塞点：交换机
* 通知点：流量接收者
* 反应点：流量发送端


发送方（RP）以最高速开始发送，沿途过程中如果有拥塞，会被标记ECN显示拥塞，当这个被标记的报文转发到接收方（NP）的时候，接收方（NP）会回应一个CNP报文，通知发送方（RP）。收到CNP报文的发送方（RP），就会开始降速。当发送方没有收到CNP报文时，就开始又提速了，上述过程就是DCQCN的基本思路。

### Congestion Point（拥塞点）

当队列长度超过ECN标记阈值时，数据包在ECN位上标记，其概率与队列长度成比例。 这些标记的数据包是显示发生拥塞的信号。优先流控制PFC 用于防止数据包丢失。 当队列长度超过PFC阈值时，PFC数据包将发送到上游端口以阻止它们发送。

### Notification Point（通知点）


当拥塞点（流的接收端）接收数据包时，它检查其ECN位。如果一个接收端接收到带有ECN标记的分组，则它向流的发送端发送拥塞通知分组a congestion notification packet （CNP），并且在下一个固定的时间段内，例如50微秒，它将不再针对相同的流发送CNP。CNP是拥塞信号，通知发送者控制流速。


### Reaction Point（反应点）

当流量发送端接收到CNP时，它会按比例减少流量，该切割比的计算类似于DCTCP。当接收到CNP时，切割比率增加。 并且当流速增加时，切割比降低。

当接收到CNP时，反应点的速率调整和QCN一致。

定时器和字节计数器用于发送端以进行速率恢复，当发送方未在固定时间内收到CNP时，它会根据其先前的状态增加流量。
加速有三种状态，如QCN，快速恢复，加性增加和超增加。
在快速恢复中，发送方将流速增加到上次切割前的速率。快速恢复将持续到，恢复到目标速率
在加性增长中，流速相加地增加，也就是说，使用固定的增加步骤。
在超级增长中，增加步骤随着增加的时间增长而增长。

## 总结

### 优点

利用类似DCTCP显式反馈策略，结合QCN的速率控制，可以在PFC机制触发前缓解拥塞。减少PFC机制的触发。

### 缺点

仍然需要依靠PFC来实现无损网络；与DCTCP一样存在队列排队延迟的问题；丢包重传采用 Go back N 机制


## 论文名

Congestion Control for Large-Scale RDMA Deployments
