# QCN拥塞控制算法

## 论文名

Data Center Transport Mechanisms: Congestion Control Theory and IEEE Standardization

## 概述

QCN（Quantized Congestion Notification，量化拥塞通知）是一套应用于L2的端到端拥塞通知机制，通过交换机主动反向发送包含拥塞程度的通知报文，降低发送端的发送速率，又通过主动增速机制来尽可能地利用可用带宽，从而提高网络性能。QCN于2007年提出，其协议规范是IEEE标准(802.1Qau)，主要应用于数据中心场景。

## QCN中的基本概念

RP（Reaction Point）：数据流的发送端，指代网卡，支持QCN协议。
CP（Congestion Point）：使能QCN功能的网络交换设备，可以进行拥塞信息检测。
CNM（Congestion Notification Message）：网络设备检测发生拥塞后发送给数据流源端的报文，启动包含拥塞程度的信息。


## QCN具体算法

量化拥塞通知QCN主要有两部分算法组成，CP算法和RP算法。

### CP算法（拥塞点算法）

发生拥塞的网络交换设备（交换机）对正在发送缓存中准备发送的数据帧进行取样。如果发现出现拥塞，将会产生一个拥塞通告消息（CNM）给被取样的数据帧的发送端。CNM报文的目的MAC为当前采样报文的源MAC，源MAC为当前采样报文的目的MAC，保证CNM报文能发送回RP端，并将采样报文中的Vlan tag、CN-TAG信息填入CNM报文。根据IEEE标准，CP是一个具有输出缓存的交换机，该缓存如下图所示。CP算法的目的就是将缓存的占用率维持在期望点Q*eq*。CP会按照与当前拥塞程度相关的概率来采样进入到交换机的数据包，计算拥塞度量值F*b*，并将该值反馈给采样数据包的源点。

具体地，我们来看一下CP算法涉及到的变量：

* Q：表示采样时刻的瞬间队列大小
* Q*eq* ：表示期望队列大小
* Q*off* ：表示采样时刻瞬时队列和期望队列的差值
* Q*old* ：表示上次采样的队列大小
* Q*δ*：表示采样时刻瞬时队列和上次采样队列大小的差值
* F*b* ：表示CP端拥塞状态的一个量化的值，6比特，在CNM消息中填充来通知RP端拥塞程度

可以得出：

Q*off* = Q - Q*eq*

Q*δ* = Q - Q*old*

F*b*的值被设置为：

F*b* = -（Q*off* + *w*Q*δ*）

可以看出，F*b*的大小是由队列大小超额值（Q*off*）和队列大小上升速率（Q*δ*）的组合共同决定的，实际上，Q*δ* = Q - Q*old*是队列大小的导数，等于输入速率减去输出速率。

*w*是一个权重，非负常量（标准中提到在模拟时取值为2），CP根据F*b*的值来决定是否产生CNM报文。当 F*b* >=0时，说明队列没有拥塞；当 F*b* <0时，说明队列拥塞，产生CNM报文反向通知产生该拥塞的数据源RP进行降速。 F*b*在发送之前会被量化成一个6比特的数值封装在CNM报文中。


### RP算法（接收点算法）

在网络中发生拥塞时，RP可以根据CNM中的F*b*信息降低发送流量的速率，但是没有拥塞发生时，网络没有向RP提供增速信号，因此它需要一种机制来自行提高其发送速率。由于以太网中没有Ack确认机制，因此速率的增加需要在RP内部通过计时来实现。

介绍RP算法之前，先来看一下该算法涉及到的几个概念：

* CR ：当前速率，速率限制器（RL）限制后的当前发送速率
* TR ：目标速率，在收到最后一个CNM消息之前的发送速率，是CR调整的目标速率
* BC ：Byte Counter，用于统计RL发送出去的字节数的计数器，用来实现增速阶段计时的功能
* Timer ：RP端的定时器，同样用于计时，能够在可用带宽很多时使得RL迅速增加发送速率

RP算法主要包括两个部分：速度降低过程和速度增大过程。

**速度降低过程**

只有当收到CNM时，RP才会降低发送速率，在收到CNM后，TR被更新为降速之前的CR，CR按照如下公式调整速率：

TR = CR

CR = CR * (1-G*d*|F*b*|)

其中G*d*是一个常量，其取值需要保证G*d*|F*b*|*max* = 0.5 ，因此收到CNM之后速率最多降低到原来速率的一半。

**速度增大过程**

速度增大过程分为两个阶段：快速恢复阶段和主动增加阶段。

* 快速恢复阶段（FR）

每当速率速率降低时，字节计数器将会被重置，同时进入了快速恢复阶段，该阶段包括5个周期，每一个周期等于RL发送150 KB的字节数据。在每个周期最后，TR保持不变，CR按照下面的公式更新：

CR = 0.5 * (CR + TR)

一个周期选择150 KB字节相当于RL发送100个大小为1500B的数据包，假设对应的CP端最小的采样概率为1%，那么当一个周期没有收到CNM报文，RP就会认为没有拥塞发生，然后就按照上面的公式增加速率，已恢复之前损失的带宽。

* 主动增加阶段（AI）

在快速恢复的5个周期执行完毕后，字节计数器进入主动增加阶段，该阶段用于发现多余的可用带宽。此时RP将探测周期设置为50或者100个帧，每个周期结束后，RP按照如下方式调整TR和CR：

TR = TR + R*ai*

CR = 0.5 * (CR + TR)

R*ai*是一个常量，标准中给出的是5Mbps。

## 注：Timer的作用

Timer的作用和字节计数器的作用是一样的，都是在速率增加阶段实现周期计时的作用。但是当CR很小的时候，使用字节计数器来通过发送字节数来计算周期，在时间上会比较久，带宽占用的恢复比较慢，因此引入了Timer计时器。在快恢复阶段，标准中一个周期设置为10 ms，在主动增加阶段，周期设置为5 ms。在使用上，字节计数器和Timer计数器同时且独立的运行，具体地：

* 当字节计数器和Timer计数器都处在快恢复阶段，那么RL就处于快恢复阶段，只要其中之一到期，就按照快恢复阶段的公式来更新速率。
* 当字节计数器和Timer计数器两者之一处在主动增加阶段，那么RL就处于主动增加阶段，只要其中之一到期，就按照主动增加阶段的公式来更新速率。
* 当字节计数器和Timer计数器都处在主动增加阶段，那么RL就处于超主动增加阶段，只要其中之一到期就按照如下公式更新速率

TR = TR + R*hai*

CR = 0.5 * (CR + TR)

其中R*hai*是一个常数，在标准中被设置为50 Mbps。

## 总结

QCN不能用于IP路由网络中，因为流的定义完全基于L2地址。 在IP路由网络中，当数据包通过网络传输时，原始的以太网报头不会保留，拥塞的交换机无法确定导致其拥塞的源目标目标，所以QCN在大规模IP网络中无法部署使用，但是QCN算法中的思想仍然值得我们了解和学习。

