# QCN拥塞控制算法

## 概述

QCN（Quantized Congestion Notification，量化拥塞通知）是一套应用于L2的端到端拥塞通知机制，通过交换机主动反向发送包含拥塞程度的通知报文，降低发送端的发送速率，又通过主动增速机制来尽可能地利用可用带宽，从而提高网络性能。QCN于2007年提出，其协议规范是IEEE标准(802.1Qau)，主要应用于数据中心场景。

## QCN中的基本概念

RP（Reaction Point）：数据流的发送端，指代网卡，支持QCN协议。
CP（Congestion Point）：使能QCN功能的网络交换设备，可以进行拥塞信息检测。
CNM（Congestion Notification Message）：网络设备检测发生拥塞后发送给数据流源端的报文，启动包含拥塞程度的信息。


## QCN具体算法

量化拥塞通知QCN主要有两部分算法组成，CP算法和RP算法。

### CP算法（拥塞点算法）

发生拥塞的网络交换设备（交换机）对正在发送缓存中准备发送的数据帧进行取样。如果发现出现拥塞，将会产生一个拥塞通告消息（CNM）给被取样的数据帧的发送端。CNM报文的目的MAC为当前采样报文的源MAC，源MAC为当前采样报文的目的MAC，保证CNM报文能发送回RP端，并将采样报文中的Vlan tag、CN-TAG信息填入CNM报文。根据IEEE标准，CP是一个具有输出缓存的交换机，该缓存如下图所示。CP算法的目的就是将缓存的占用率维持在期望点Q*eq*。CP会按照与当前拥塞程度相关的概率来采样进入到交换机的数据包，计算拥塞度量值F*b*，并将该值反馈给采样数据包的源点。

具体地，我们来看一下CP算法涉及到的变量：

* Q：表示采样时刻的瞬间队列大小
* Q*eq* ：表示期望队列大小
* Q*off* ：表示采样时刻瞬时队列和期望队列的差值
* Q*old* ：表示上次采样的队列大小
* Q*δ*：表示采样时刻瞬时队列和上次采样队列大小的差值
* F*b* ：表示CP端拥塞状态的一个量化的值，6比特，在CNM消息中填充来通知RP端拥塞程度

可以得出：

Q*off* = Q - Q*eq*

Q*δ* = Q - Q*old*

F*b*的值被设置为：

F*b* = -（Q*off* + *w*Q*δ*）

可以看出，F*b*的大小是由队列大小超额值（Q*off*）和队列大小上升速率（Q*δ*）的组合共同决定的，实际上，Q*δ* = Q - Q*old*是队列大小的导数，等于输入速率减去输出速率。

*w*是一个权重，非负常量（标准中提到在模拟时取值为2），CP根据F*b*的值来决定是否产生CNM报文。当 F*b* >=0时，说明队列没有拥塞；当 F*b* <0时，说明队列拥塞，产生CNM报文反向通知产生该拥塞的数据源RP进行降速。 F*b*在发送之前会被量化成一个6比特的数值封装在CNM报文中。


### RP算法（接收点算法）

