# 网络拥塞


## 什么是拥塞

拥塞可以看作是一个“资源”上的概念，即当可用资源少于需要的资源时便会产生拥塞，也就是资源不够用了。当最大的可用资源不变时，拥塞发生时，只好减少需要的资源，如何减少以及减少多少则是由不同的拥塞控制算法决定的，此外，还有一个关键点就是如何判断拥塞发生，这也是区分拥塞控制算法的一个关键机制。

**注**：传统网络是分布式的，因此发送者不知道何时按照多大的速率发送消息能够使得网络性能最好。

在网络中，上述的资源可以是转发设备的CPU、队列、物理链路带宽等。当发生拥塞时，会造成丢包事件，这在可靠传输中是不允许的，因此TCP协议中针对丢包事件采用了“重传”机制，重传能够保证不丢包，但是会降低网络性能【一旦发生丢包，传输层通常会惩罚性地乘性减慢（Multiplicative-decrease）发送速率，并重传丢弃的数据包，用户会感受到突发的性能降级】，因此诸多拥塞控制机制被提出，尽可能地避免拥塞发生，或者在拥塞发生时尽量保证网络性能。


## 为什么会发生拥塞

当发送方发包速率超过了接收方的处理能力时，数据包开始在接收方的接收队列中积压，如果积压情况持续没有缓解直到接收队列满载，接收方只能选择将之后接收到的数据包丢弃。这里的接收方可能是数据包的最终接收者或者中间经过的交换机、路由器。

以下原因导致了拥塞在网络中（特别是数据中心网络中）很容易发生：

* 普通交换机的浅缓冲区特性。由于成本原因，数据中心交换机的缓冲区一般都不大（几 MB 到数十 MB）。这些缓冲区被所有端口共享，以便实现统计意义的多路复用。
* 许多分布式应用都遵循 Partition/Aggregate 这种通信模式。一个请求可能分散到多个工作节点进行处理，每个节点处理数据集的一部分。处理完毕后，所有的工作节点几乎同时地把结果汇聚到同一个节点做数据整合。这是典型Many-to-One场景（又称为Incast），汇聚节点所在的端口很容易出现数据包积压。
* 多路径负载不均衡。当网络拓扑中存在多条可达路径时，网络通过ECMP（Equal-cost multi-path）为每个Flow选择合适的路由，但是ECMP没有感知拥塞情况的能力，Flow可能被分配到拥塞程度已经十分严重的路径，引起拥塞加剧和丢包。


## 拥塞控制算法

按照检测拥塞方式，现有拥塞控制算法大致可以归为三类：基于丢包检测、基于ECN的检测和基于RTT的检测。此外，随着INT的发展，利用更加详细具体的网络状态信息来检测拥塞的方式也被研究人员提出，如阿里巴巴的HPCC拥塞控制机制。

### 基于丢包检测

基于丢包检测的原理很显然，丢包是拥塞持续得不到缓解的最终结果。TCP经典的Tahoe算法和CUBIC算法，都是基于丢包来做检测的。上文提到，丢包对网络的性能影响很大大，如果等到已经丢包再进行控制成本就太高了，因此这种方式弊端很明显。

### 基于ECN检测

ECN（Explicit Congestion Notification）是IP头部Differentiated Services字段的后两位，用于指示是否发生了拥塞。它的四种取值的含义如下：

* 00：表示发送方不支持ECN（Non ECN-Capable Transport）
* 01：表示发送方支持ECN（ECN-Capable Transport）
* 10：同上
* 11：表示发生了拥塞（Congestion Encountered）

如果通信双方都支持 ECN（ECN 为01或者10），当拥塞出现时，交换机会更新报文的ECN为 11（Congestion Encountered），再转发给下一跳。接收方可以根据ECN标志向发送方汇报拥塞情况，调节发送速率。当RED和ECN同时开启，拥塞发生时交换机不再随机丢包，而是随机为报文设置ECN。


### 基于RTT检测

RTT（Round-Trip Time）是发送方将数据包发送出去，到接收到对端的确认包之间的时间间隔。RTT能够反映端到端的网络延迟，如果发生拥塞，数据包会在接收队列中排队等待，RTT也会相应较高。而ECN只能够反映超过队列阈值的包数量，无法精确量化延迟。

RTT 可以选择在软件层或者硬件层做统计。一般网卡接收到数据包后，通过中断通知上层，由操作系统调度中断处理收包事件。中断和调度都将引入一些误差。因此，更精确地统计最好由硬件完成，当网卡接收到包时，网卡立即回复一个ACK包，发送方可以根据它的到达时间计算RTT。

需要注意的是，ACK回复包如果受到其他流量影响遇到拥塞，那么RTT计算会有偏差。可以为ACK回复包设置更高优先级。或者保证收发两端网卡的时钟基本上同步，然后在回复包加上时间戳信息。另外，网络路径的切换也会带来一些延迟的变化。


当检测出拥塞时，会根据拥塞控制算法来减低发送者的速率；当没有拥塞发生时，按照策略来增加发送者速率。关于发送者速率可以通过调整窗口的方式或者直接调整速率的方式来更新发送者速率。


## 注1：关于链路

关于一条物理链路有三个重要的物理性质：

* 延迟（毫秒）：一个数据包从链路的起点到终点所花费的时间
* 带宽（Mb/s）：一秒钟内可通过链路的字节数
* 队列：链接已满时用于存储等待发送的数据包的队列大小，以及在达到其容量时管理该队列的策略

将链接比作管道，延迟可视为管道的长度，带宽可视为管道横截面积大小。另一个有关链路重要统计数据的参数是带宽延迟积（bandwidth-delay product，BDP），这是带宽和延迟的乘积，是在任何给定时间点上可容纳在链路上的字节数。在管道类比中可以认为是管道的体积。当流经该链接的字节数等于BDP时，该链接已被充分利用。如果发送者发送的字节多于BDP，则链接的队列将填满并最终开始丢弃数据包。

## 注2：未来安排

一个拥塞控制机制应该包括：拥塞检测机制；当拥塞发生时如何降低发送者速率；当没有发生拥塞时，如何提高发送者速率以更多地使用可用资源。后面的文章将总结常见的拥塞控制算法，包括传统TCP网络、数据中心网络以及RDMA网络三种场景下的典型拥塞控制算法。


