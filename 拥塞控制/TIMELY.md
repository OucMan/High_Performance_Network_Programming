# TIMELY

## 背景

TIMELY是第一个在数据中心使用的基于延迟的拥塞控制协议。按照拥塞通知的实现，目前主要有两种类型的拥塞控制协议：基于ECN的拥塞控制和基于延时的拥塞控制。

**RTT作为拥塞信号的优点**

RTT之所以有价值，是因为它们直接衡量我们关心的数量： 网络排队导致的端到端延迟。而从队列占用率得出的信号（例如ECN）无法直接告知该指标，数据包上的ECN标记仅表示与数据包相对应的队列度量值超过阈值。具有不同优先级的多个队列共享同一输出链路，但是ECN标记仅提供有关占用率超过阈值的队列的信息。低优先级的流量可能会经历较大的排队延迟，而不必具有大的队列占用率。在这种情况下，排队延迟反映了网络中的拥塞状态，而低优先级流量的队列占用率却没有反映该问题。此外，ECN标记描述了单个交换机的行为。在利用率很高的网络中，拥塞发生在多个交换机上，ECN信号在它们之间无法分辨。

而且目前使用网卡硬件的形式来进行RTT测量具有很高的精确度（微秒级别）。


## TIMELY算法

TIMELY为速率控制提供了一个框架，下图显示了它的三个组成部分：

* RTT Measurement Engine：测量RTT，监视网络的拥塞情况；
* Rate Computation Engine：将RTT信号转换为目标发送速率的计算引擎；
* Rate Control Engine：在各段（64KB）之间插入延迟以达到目标速率。

![TIMELY架构](https://github.com/OucMan/High_Performance_Network_Programming/blob/master/%E6%8B%A5%E5%A1%9E%E6%8E%A7%E5%88%B6/pic/timely-01.png)

### RTT Measurement Engine

该组件实现了对RTT的测量。首先介绍一下时延。网络时延主要由四个部分组成：发送时延、传播时延、处理时延（网卡产生ACK的时延）和排队时延。论文将RTT定义为传播时延+排队时延。对于发送时延，就是网卡将数据包发送到链路上的时间，等于数据包的尺寸除以网卡带宽，处理时延，即网卡产生ACK的时延接近零，因此忽略不计。因此本文中RTT的计算如下式：

RTT = T*completion* - T*send* - seg.size / NIC*linerate*

### Rate Computation Engine

该组件实现了基于RTT的拥塞控制算法。

对于计算输出速率的引擎，它必须要满足两个需求：即必须提供低延迟(对于短流)和高吞吐量(对于长流)的网络利用率。 TIMELY的拥塞控制器通过对延迟梯度或排队随时间变化的微分做出反应，从而实现了低延迟，而不是试图保持排队。由于RTT增加而导致的正延迟梯度表示队列增加，而负梯度表示队列减少。通过使用梯度，可以对队列增长做出反应，而无需等待队列，从而形成一种实现低延迟的策略。

具体的拥塞控制算法如下图所示

![TIMELY算法](https://github.com/OucMan/High_Performance_Network_Programming/blob/master/%E6%8B%A5%E5%A1%9E%E6%8E%A7%E5%88%B6/pic/timely-02.png)

首先对new_rtt做一次判断，如果它小于阈值T*low*或者大于阈值T*high*，那就直接对发送速率进行增减。

如果new_rtt落在了中间区域，那么首先就要对延时梯度进行计算。延时梯度等于最新的rtt减去上一个rtt再除以20 µs（微秒），它是一个无量纲的数字。如果梯度小于或等于零，网络可以有更高的速率，发送速率增加一个恒定的值来探测更多的带宽。如果梯度为正，则发送速率超过网络容量，并执行乘法速率递减。计算得到这个发送速率之后，在pacing engine中，使用调度器来处理流。它根据当前段的大小、流率和最后一次传输的时间计算当前段的发送时间，然后将该段放入优先队列中。



### Rate Control Engine

当准备好发送一条消息时，速率控制引擎将其分成多个段进行传输，然后将每个段依次发送到调度程序。调度程序使用段大小，流率（由速率计算引擎提供）和上次传输时间来计算当前段的发送时间以及适当的发送延迟，然后将该段放置在调度程序中的优先级队列中。过去具有发送时间的段以轮询方式进行服务；具有未来发送时间的段被排队。在经过发送延迟之后，速率控制引擎将分段传递到NIC，以作为数据包突发立即传输。



## 总结

该论文中基于时延梯度的拥塞控制算法，即利用时延梯度来指示队列的增减。对于丢包现象，仍然使用PFC，同时，算法的参数多，如果准确地设置这些参数需要工作量。此外，最重要的是然硬件上已经避免了内核中可能的影响因素，但是一些不可避免的抖动会在反馈信号中引入延迟和噪声，影响拥塞检测的准确性。

## 论文

TIMELY: RTT-based Congestion Control for the Datacenter


